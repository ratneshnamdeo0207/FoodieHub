<% layout("layouts/boilerplate") %>

<%
  const times = [
    "08:00 AM","09:00 AM","10:00 AM","11:00 AM",
    "12:00 PM","01:00 PM","02:00 PM","03:00 PM",
    "04:00 PM","05:00 PM","06:00 PM","07:00 PM",
    "08:00 PM","09:00 PM","10:00 PM","11:00 PM"
  ];
%>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-7">

      <div class="card border-0 rounded-4 shadow-lg">
        <div class="card-body p-4">

          <h4 class="fw-bold mb-4 text-center">Create Restaurant</h4>

          <form action="/resturants" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>

            <!-- Name + Location -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Name</label>
                <input type="text"
                       class="form-control form-control-sm shadow-sm"
                       name="resturant[name]"
                       required>
                <div class="invalid-feedback">Please enter restaurant name.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input type="text"
                       class="form-control form-control-sm shadow-sm"
                       name="resturant[location]"
                       required>
                <div class="invalid-feedback">Please enter location.</div>
              </div>
            </div>

            <!-- Category -->
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select class="form-select form-select-sm shadow-sm"
                      name="resturant[Category]" required>
                <option value="" disabled selected>Select Category</option>
                <option>North Indian</option>
                <option>South Indian</option>
                <option>Chinese</option>
                <option>Fast Food</option>
                <option>Desserts</option>
                <option>Beverages</option>
              </select>
              <div class="invalid-feedback">Please select a category.</div>
            </div>

            <!-- Opening + Closing -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Opening Hour</label>
                <select name="resturant[openingHour]"
                        class="form-select form-select-sm shadow-sm"
                        required>
                  <option value="" disabled selected>Select Opening</option>
                  <% for(let time of times){ %>
                    <option value="<%= time %>"><%= time %></option>
                  <% } %>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Closing Hour</label>
                <select name="resturant[closingHour]"
                        class="form-select form-select-sm shadow-sm"
                        required>
                  <option value="" disabled selected>Select Closing</option>
                  <% for(let time of times){ %>
                    <option value="<%= time %>"><%= time %></option>
                  <% } %>
                </select>
              </div>
            </div>

            <!-- Price -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Starting Price (₹)</label>
                <input type="number"
                       class="form-control form-control-sm shadow-sm"
                       name="resturant[startingPrice]"
                       required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Ending Price (₹)</label>
                <input type="number"
                       class="form-control form-control-sm shadow-sm"
                       name="resturant[endingPrice]"
                       required>
              </div>
            </div>

            <!-- Description -->
            <div class="mb-4">
              <label class="form-label">Description</label>
              <textarea class="form-control form-control-sm shadow-sm"
                        rows="3"
                        name="resturant[description]"
                        required></textarea>
            </div>

            <div class="mb-4">
              <label class="form-label fw-semibold">Restaurant Images</label>

              <div id="imageContainer">

                <!-- Default Image Input -->
                <div class="position-relative mb-3" id="image-0">
                  <input type="file"
                         name="images"
                         class="form-control form-control-sm shadow-sm"
                         accept="image/*"
                         required>
                </div>

              </div>

              <div class="text-end mt-2">
                <button type="button"
                        class="btn btn-sm btn-outline-dark shadow-sm"
                        onclick="addImageInput()">
                  + Add Image
                </button>
              </div>
            </div>

            <!-- Items Section -->
            <hr class="mb-3">

            <div id="itemsWrapper">
              <div id="itemsContainer"></div>

              <div class="mt-2">
                <button type="button"
                        class="btn btn-sm btn-outline-dark shadow-sm"
                        onclick="addItem()">
                  + Add Item
                </button>
              </div>
            </div>

            <!-- Submit -->
            <div class="text-end mt-4">
              <button class="btn btn-dark btn-sm px-4 shadow-sm">
                Create
              </button>
            </div>

          </form>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
let itemIndex = 0;
let imageIndex = 1; // starts from 1 because 0 already exists

function addImageInput() {
  const container = document.getElementById("imageContainer");

  const html = `
    <div class="position-relative mb-3" id="image-${imageIndex}">
      <input type="file"
             name="images"
             class="form-control form-control-sm shadow-sm"
             accept="image/*"
             required>

      <button type="button"
              class="btn-close position-absolute top-50 end-0 translate-middle-y me-2"
              onclick="removeImageInput(${imageIndex})">
      </button>
    </div>
  `;

  container.insertAdjacentHTML("beforeend", html);
  imageIndex++;
}

function removeImageInput(index) {
  const element = document.getElementById(`image-${index}`);
  if (element) element.remove();
}

/* Items */
function addItem() {
  const container = document.getElementById("itemsContainer");

  const html = `
    <div class="border rounded-4 p-3 mb-3 shadow-sm bg-white position-relative" id="item-${itemIndex}">
      <button type="button"
              class="btn-close position-absolute top-0 end-0 m-2"
              onclick="removeItem(${itemIndex})">
      </button>

      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <label class="form-label">Item Name</label>
          <input type="text"
                 class="form-control form-control-sm shadow-sm"
                 name="items[${itemIndex}][name]"
                 required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Price (₹)</label>
          <input type="number"
                 class="form-control form-control-sm shadow-sm"
                 name="items[${itemIndex}][price]"
                 required>
        </div>

        <div class="col-12">
          <label class="form-label">Description</label>
          <input type="text"
                 class="form-control form-control-sm shadow-sm"
                 name="items[${itemIndex}][description]"
                 required>
        </div>

        <div class="col-12">
          <label class="form-label">Image URL</label>
          <input type="file"
                 class="form-control form-control-sm shadow-sm"
                 name="items[${itemIndex}][image]"
                 required>
        </div>
      </div>
    </div>
  `;

  container.insertAdjacentHTML("beforeend", html);
  itemIndex++;
}

function removeItem(index) {
  const item = document.getElementById(`item-${index}`);
  if (item) item.remove();
}

/* Bootstrap Validation */
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');

  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();
</script>
