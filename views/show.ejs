<% layout("layouts/boilerplate") %>

<div class="container py-5">

  <!-- ===== Restaurant Section ===== -->
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="row g-0">

      <!-- Image -->
      <div class="col-md-6">
  <div style="
        height: 450px;
        overflow: hidden;
        border-radius: 20px 0 0 20px;
      ">
    <img 
      src="<%= rest.image.url %>" 
      alt="<%= rest.image.filename %>"
      style="
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      ">
  </div>
</div>


      <!-- Details -->
      <div class="col-md-6 p-4 p-lg-5">

        <h2 class="fw-bold mb-2"><%= rest.name %></h2>

        <p class="text-muted mb-2">
          <i class="bi bi-geo-alt-fill"></i> <%= rest.location %>
        </p>

       <% if (rest.reviews.length != 0) { %>
         <h5 class="text-warning mb-3">
        
          ‚≠ê <%= rest.rating %> / 5
        </h5>
       <% } else{ %>
        <p>‚≠ê Be the first one to rate ‚≠ê</p>                         

      <% }  %>

        <p class="text-secondary">
          <%= rest.description %>
        </p>

        <hr>

        <div class="row mb-3">
          <div class="col-6">
            <strong>Category:</strong><br>
            <span class="text-muted"><%= rest.Category %></span>
          </div>

          <div class="col-6">
            <strong>Price Range:</strong><br>
            <span class="text-muted">
              ‚Çπ<%= rest.startingPrice %> ‚Äì ‚Çπ<%= rest.endingPrice %>
            </span>
          </div>
        </div>

        <p>
          <strong>Timings:</strong>
          <span class="text-muted">
            <%= rest.openingHour %> ‚Äì <%= rest.closingHour %>
          </span>
        </p>
        <% if (currUser && currUser.id == rest.owner.id) { %>
         
          <div class="mt-4">
            <a href="/show/<%= rest.id %>/edit" 
               class="btn btn-outline-dark rounded-pill px-4 me-2">
              Edit
            </a>
  
            <form action="/show/<%= rest.id %>?_method=DELETE" 
                  method="POST" 
                  class="d-inline">
              <button class="btn btn-danger rounded-pill px-4">
                Delete
              </button>
            </form>

               <!-- <div class="text-end mt-4"> -->
              <button class="btn btn-dark rounded-pill px-4"
                      data-bs-toggle="collapse"
                      data-bs-target="#addItemForm">
                + Add Item
              </button>
            <!-- </div> -->

          </div>
        <% } %>

      </div>
    </div>
  </div>

   <% if (currUser && currUser.id == rest.owner.id) { %>

    <div class="collapse mt-4" id="addItemForm">
      <div class="card border-0 shadow-sm rounded-4 p-4">

        <h5 class="mb-4 fw-bold">Add New Menu Item</h5>

<form action="/show/<%= rest._id %>/item"
      method="POST"
      enctype="multipart/form-data">

  <div class="row">

    <!-- Item Name -->
    <div class="col-md-6 mb-3">
      <label class="form-label fw-semibold">Item Name</label>
      <input type="text"
             name="item[name]"
             class="form-control rounded-3"
             placeholder="Enter item name"
             required>
    </div>

    <!-- Price -->
    <div class="col-md-6 mb-3">
      <label class="form-label fw-semibold">Price (‚Çπ)</label>
      <input type="number"
             name="item[price]"
             class="form-control rounded-3"
             placeholder="Enter price"
             required>
    </div>

    <!-- Description -->
    <div class="col-12 mb-3">
      <label class="form-label fw-semibold">Description</label>
      <textarea name="item[description]"
                class="form-control rounded-3"
                rows="3"
                placeholder="Write short description"
                required></textarea>
    </div>

    <!-- Image Upload Section -->
    <div class="col-12 mb-3">

      <label class="form-label fw-semibold">Upload Images</label>

      <div id="imageContainer">

        <div class="input-group mb-2 image-input">
          <input type="file"
                 name="image"
                 class="form-control"
                 accept="image/*"
                 required>

          <!-- <button type="button"
                  class="btn btn-outline-danger"
                  onclick="removeImage(this)">
            ‚úï
          </button> -->
        </div>

      </div>

      <!-- Add Image Button (Left Side) -->
      <!-- <div class="text-start mt-2">
        <button type="button"
                class="btn btn-outline-dark rounded-pill px-4"
                onclick="addImageField()">
          + Add Image
        </button>
      </div> -->

    </div>

  </div>

  <div class="text-end">
    <button class="btn btn-success rounded-pill px-4">
      Save Item
    </button>
  </div>

</form>


      </div>
    </div>

  <% } %>


  <!-- ===== Menu Section ===== -->
  <div class="mt-5">
    <h4 class="mb-4 fw-bold">Our Menu</h4>

    <div class="row g-4">
      <% if(items && items.length > 0){ %>
        <% for(let item of items){ %>

          <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">

              <img 
                src="<%= item.image.url %>"
                class="card-img-top"
                style="height: 220px; object-fit: cover;"
                alt="<%= item.image.filename %>"
              >

              <div class="card-body p-4 d-flex flex-column">

                <h5 class="fw-bold mb-1">
                  <%= item.name %>
                </h5>

                <h6 class="text-success fw-semibold mb-2">
                  ‚Çπ<%= item.price %>
                </h6>

                <p class="text-muted small flex-grow-1">
                  <%= item.description %>
                </p>
<div class="d-flex gap-2 mt-2">

      <a href="?editId=<%= item._id %>"
         class="btn btn-sm btn-outline-primary rounded-pill">
        Edit
      </a>

      <form action="/items/<%= item._id %>?_method=DELETE"
            method="POST"
            class="d-inline">
        <button class="btn btn-sm btn-outline-danger rounded-pill">
          Delete
        </button>
      </form>

    </div>
                <button class="btn btn-dark rounded-pill mt-3">
                  Add to Cart
                </button>

              </div>
            </div>




            
          </div>

        <% } %>
      <% } else { %>
         <div class="container">
            <div class="alert alert-secondary
             text-center my-4 py-5">
                This resturant dont have any item
            </div>
        </div>
      <% } %>
    </div>
  </div>

  <!-- ===== Review Form ===== -->
 
    <% if (currUser && currUser.id != rest.owner.id) { %>
       <div class="card border-0 shadow-sm rounded-4 p-4 mt-5">
    <h4 class="mb-4">Leave a Review</h4>

    <form action="/show/<%= rest.id %>/review" 
          method="POST" 
          novalidate 
          class="needs-validation">

      <!-- Rating -->
      <div class="mb-3">
        <fieldset class="starability-coinFlip mb-3">
          <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked />
          <input type="radio" id="rate1" name="review[rating]" value="1" /><label for="rate1">1 star.</label>
          <input type="radio" id="rate2" name="review[rating]" value="2" /><label for="rate2">2 stars.</label>
          <input type="radio" id="rate3" name="review[rating]" value="3" /><label for="rate3">3 stars.</label>
          <input type="radio" id="rate4" name="review[rating]" value="4" /><label for="rate4">4 stars.</label>
          <input type="radio" id="rate5" name="review[rating]" value="5" /><label for="rate5">5 stars.</label>
          <span class="starability-focus-ring"></span>
        </fieldset>
        <div class="invalid-feedback">Please select a rating</div>
      </div>

      <!-- Comment -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Comment</label>
        <textarea 
          name="review[comment]" 
          class="form-control rounded-3" 
          rows="4" 
          placeholder="Write your experience..."
          required>
        </textarea>
        <div class="invalid-feedback">Please add a comment</div>
      </div>

      <button class="btn btn-dark rounded-pill px-4">
        Submit Review
      </button>

    </form>
  </div>
    <% } %>

  <!-- ===== Reviews Section ===== -->
  <div class="mt-5">
    <% if (rest.reviews && rest.reviews.length > 0) { %>
    <h4 class="mb-4">Customer Reviews</h4>
<% } %>

    <div class="row g-4">
  <% for(let r of rest.reviews){ %>
<div class="col-md-4">
  <div class="card border-0 shadow-sm rounded-4 h-100 p-4">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="text-warning mb-0">‚≠ê <%= r.rating %></h6>
      
      <small class="text-muted">
        <%= new Date(r.createdAt).toDateString() %>
      </small>
    </div>

    <!-- Normal View -->
    <div id="view-<%= r._id %>">
      <p class="text-secondary"><%= r.comment %></p>
      <strong class="text-muted ">
      @<%= r.author ? r.author.username : "Anonymous" %>
      </strong>
      <hr>
      <% if(currUser && currUser.id == r.author.id){ %>
      <div class="d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-primary rounded-pill"
                onclick="toggleEdit('<%= r._id %>')">
          ‚úè Edit
        </button>

        <form action="/show/<%= rest._id %>/review/<%= r._id %>?_method=DELETE"
              method="POST">
          <button class="btn btn-sm btn-outline-danger rounded-pill">
            üóë Delete
          </button>
        </form>
      </div>
      <% } %>
    </div>

    <!-- Edit Form (Hidden Initially) -->
    <div id="edit-<%= r._id %>" class="d-none">
      <form action="/show/<%= rest._id %>/review/<%= r._id %>?_method=PUT"
            method="POST">

        <div class="mb-2">
          <input type="number"
                 name="review[rating]"
                 value="<%= r.rating %>"
                 class="form-control"
                 min="1"
                 max="5"
                 required>
        </div>

        <div class="mb-2">
          <textarea name="review[comment]"
                    class="form-control"
                    rows="3"
                    required><%= r.comment %></textarea>
        </div>

        <div class="d-flex justify-content-between">
          <button class="btn btn-sm btn-success rounded-pill">
            ‚úî Save
          </button>

          <button type="button"
                  class="btn btn-sm btn-secondary rounded-pill"
                  onclick="toggleEdit('<%= r._id %>')">
            Cancel
          </button>
        </div>
      </form>
    </div>

  </div>
</div>
<% } %>

</div>

  </div>

</div>
